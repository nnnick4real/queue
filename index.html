<!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘  Tesla äº¤ä»˜ä¸­å¿ƒ | è™Ÿç¢¼ç‰Œå«è™Ÿç³»çµ±              â•‘
  â•‘  Version 1.0                                  â•‘
  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
  â•‘  Views (é€é URL åƒæ•¸åˆ‡æ›):                    â•‘
  â•‘  - è»Šä¸»ç«¯ (é è¨­):  ?mode=kiosk                â•‘
  â•‘  - ç®¡ç†ç«¯:         ?mode=admin                â•‘
  â•‘  - é›»è¦–çœ‹æ¿:       ?mode=tv                   â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tesla äº¤ä»˜ä¸­å¿ƒ | è™Ÿç¢¼ç‰Œç³»çµ±</title>
    <meta name="description" content="Tesla äº¤ä»˜ä¸­å¿ƒæ•¸ä½è™Ÿç¢¼ç‰Œå«è™Ÿç³»çµ±">

    <!-- Firebase SDK (compat ç‰ˆæœ¬) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           Tesla Design System â€” å…¨åŸŸæ¨£å¼
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0a0a;
            --surface: #161616;
            --surface-2: #1e1e1e;
            --surface-3: #282828;
            --border: #333;
            --red: #e82127;
            --red-dark: #b91a1f;
            --red-glow: rgba(232, 33, 39, 0.25);
            --green: #00c853;
            --amber: #ffab00;
            --text: #ffffff;
            --text-2: #a0a0a0;
            --text-3: #666;
            --radius: 12px;
            --radius-lg: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .view {
            display: none;
            min-height: 100vh;
            min-height: 100dvh;
        }

        .view.active {
            display: flex;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: flex;
        }

        /* â”€â”€ é€šç”¨å…ƒä»¶ â”€â”€ */
        .tesla-wordmark {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 12px;
            text-transform: uppercase;
            color: var(--text);
            text-indent: 12px;
        }

        .tesla-wordmark.large {
            font-size: 42px;
            letter-spacing: 18px;
            text-indent: 18px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--red), var(--red-dark));
            color: #fff;
            font-size: 16px;
            padding: 14px 28px;
            box-shadow: 0 4px 15px var(--red-glow);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 30px var(--red-glow);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: scale(0.96) translateY(0);
        }

        .btn-secondary {
            background: var(--surface-2);
            color: var(--text);
            font-size: 14px;
            padding: 10px 20px;
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface-3);
        }

        .btn-danger {
            background: transparent;
            color: var(--red);
            font-size: 14px;
            padding: 10px 20px;
            border: 1px solid var(--red);
        }

        .btn-danger:hover {
            background: rgba(232, 33, 39, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-green {
            background: rgba(0, 200, 83, 0.15);
            color: var(--green);
        }

        .badge-red {
            background: rgba(232, 33, 39, 0.15);
            color: var(--red);
        }

        .badge-amber {
            background: rgba(255, 171, 0, 0.15);
            color: var(--amber);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CONFIG ERROR ç•«é¢
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #screen-error {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 24px;
            text-align: center;
        }

        #screen-error.active {
            display: flex;
        }

        #screen-error h1 {
            font-size: 24px;
            margin-bottom: 12px;
        }

        #screen-error p {
            color: var(--text-2);
            max-width: 480px;
            line-height: 1.7;
        }

        #screen-error code {
            display: block;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            text-align: left;
            font-size: 13px;
            color: var(--amber);
            white-space: pre;
            overflow-x: auto;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           KIOSK / è»Šä¸»ç«¯
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #view-kiosk {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            position: relative;
        }

        /* â”€â”€ é ˜è™Ÿç•«é¢ â”€â”€ */
        #kiosk-landing {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 40px;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 40px 24px;
        }

        .landing-subtitle {
            font-size: 18px;
            color: var(--text-2);
            font-weight: 300;
        }

        .btn-take {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: 700;
            background: radial-gradient(circle at 40% 40%, #f03030, var(--red-dark));
            color: #fff;
            border: none;
            cursor: pointer;
            box-shadow: 0 0 50px var(--red-glow), inset 0 -4px 12px rgba(0, 0, 0, 0.3);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            animation: btn-breathe 3s ease-in-out infinite;
        }

        .btn-take:hover {
            box-shadow: 0 0 70px rgba(232, 33, 39, 0.4), inset 0 -4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-take:active {
            transform: scale(0.92);
            animation: none;
        }

        .btn-take .icon {
            font-size: 36px;
        }

        @keyframes btn-breathe {

            0%,
            100% {
                box-shadow: 0 0 40px var(--red-glow), inset 0 -4px 12px rgba(0, 0, 0, 0.3);
            }

            50% {
                box-shadow: 0 0 65px rgba(232, 33, 39, 0.4), inset 0 -4px 12px rgba(0, 0, 0, 0.3);
            }
        }

        /* â”€â”€ ç­‰å¾…ç•«é¢ â”€â”€ */
        #kiosk-waiting {
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 40px 24px;
            gap: 28px;
        }

        .my-ticket {
            text-align: center;
            padding: 30px;
            margin-top: 20px;
        }

        .my-ticket .label {
            font-size: 14px;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 8px;
        }

        .my-ticket .number {
            font-size: 80px;
            font-weight: 800;
            background: linear-gradient(135deg, #fff, #ccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        .queue-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 400px;
        }

        .info-card {
            text-align: center;
            padding: 16px 8px;
        }

        .info-card .label {
            font-size: 11px;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .info-card .value {
            font-size: 28px;
            font-weight: 700;
        }

        .info-card .value.red {
            color: var(--red);
        }

        .info-card .value.green {
            color: var(--green);
        }

        .wake-hint {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-3);
            padding: 10px 16px;
            background: var(--surface);
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        .progress-bar-wrap {
            width: 100%;
            max-width: 400px;
            height: 4px;
            background: var(--surface-2);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--red);
            border-radius: 2px;
            transition: width 0.6s ease;
            width: 0%;
        }

        /* â”€â”€ å«è™Ÿç•«é¢ â”€â”€ */
        #kiosk-called {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            min-height: 100dvh;
            text-align: center;
            gap: 20px;
            animation: bg-pulse-red 1.2s ease-in-out infinite;
        }

        #kiosk-called .called-icon {
            font-size: 60px;
            animation: bounce 0.8s infinite;
        }

        #kiosk-called h1 {
            font-size: 36px;
            font-weight: 800;
        }

        #kiosk-called p {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.85);
        }

        #kiosk-called .called-num {
            font-size: 100px;
            font-weight: 900;
            text-shadow: 0 0 40px rgba(255, 255, 255, 0.3);
        }

        @keyframes bg-pulse-red {

            0%,
            100% {
                background: #c41922;
            }

            50% {
                background: #8b0000;
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-12px);
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ADMIN / ç®¡ç†ç«¯
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #view-admin {
            flex-direction: column;
            min-height: 100vh;
        }

        /* â”€â”€ å¯†ç¢¼é– â”€â”€ */
        #admin-lock {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            gap: 24px;
            padding: 24px;
            text-align: center;
        }

        #admin-lock h2 {
            font-size: 22px;
            font-weight: 600;
        }

        .input-group {
            display: flex;
            gap: 8px;
            width: 100%;
            max-width: 320px;
        }

        .input-group input {
            flex: 1;
            padding: 12px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 16px;
            font-family: inherit;
            outline: none;
        }

        .input-group input:focus {
            border-color: var(--red);
        }

        .pwd-error {
            color: var(--red);
            font-size: 13px;
            display: none;
        }

        /* â”€â”€ ç®¡ç†é¢æ¿ â”€â”€ */
        #admin-panel {
            flex-direction: column;
            min-height: 100vh;
        }

        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .admin-header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .admin-body {
            padding: 24px;
            flex: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
        }

        .stat-card .label {
            font-size: 12px;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 40px;
            font-weight: 800;
        }

        .section {
            margin-bottom: 32px;
        }

        .section h3 {
            font-size: 14px;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 16px;
        }

        .action-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .btn-call-next {
            font-size: 20px;
            padding: 18px 36px;
        }

        .batch-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .batch-controls input {
            width: 60px;
            padding: 10px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 16px;
            text-align: center;
            font-family: inherit;
            outline: none;
        }

        .batch-controls input:focus {
            border-color: var(--red);
        }

        .qr-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .qr-box {
            padding: 16px;
            background: #fff;
            border-radius: var(--radius);
            display: inline-block;
        }

        .qr-url {
            font-size: 13px;
            color: var(--text-3);
            word-break: break-all;
            text-align: center;
        }

        .admin-footer {
            padding: 12px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-3);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-dot.online {
            background: var(--green);
            box-shadow: 0 0 6px var(--green);
        }

        .status-dot.offline {
            background: var(--red);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TV DISPLAY / é›»è¦–çœ‹æ¿
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #view-tv {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--bg);
            position: relative;
            overflow: hidden;
        }

        .tv-bg-glow {
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(232, 33, 39, 0.08), transparent 70%);
            pointer-events: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .tv-header {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .tv-header .tesla-wordmark {
            margin-bottom: 8px;
        }

        .tv-header .divider {
            width: 60px;
            height: 2px;
            background: var(--red);
            margin: 12px auto 0;
        }

        .tv-header .sub {
            font-size: 16px;
            color: var(--text-3);
            letter-spacing: 4px;
            margin-top: 10px;
        }

        .tv-main {
            text-align: center;
            z-index: 1;
        }

        .tv-label {
            font-size: 22px;
            color: var(--text-2);
            letter-spacing: 6px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .tv-number {
            font-size: clamp(120px, 25vw, 280px);
            font-weight: 900;
            line-height: 1;
            color: var(--text);
            text-shadow: 0 0 60px var(--red-glow);
            transition: opacity 0.3s, transform 0.3s;
        }

        .tv-number.flip {
            animation: tv-flip 0.5s ease-out;
        }

        @keyframes tv-flip {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .tv-next {
            margin-top: 20px;
            font-size: 18px;
            color: var(--text-3);
        }

        .tv-next span {
            color: var(--text-2);
            font-weight: 600;
        }

        .tv-footer {
            position: absolute;
            bottom: 40px;
            display: flex;
            gap: 40px;
            font-size: 16px;
            color: var(--text-3);
            z-index: 1;
        }

        .tv-footer .val {
            color: var(--text);
            font-weight: 700;
        }

        .tv-scanline {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(0deg,
                    transparent,
                    transparent 2px,
                    rgba(255, 255, 255, 0.01) 2px,
                    rgba(255, 255, 255, 0.01) 4px);
            pointer-events: none;
            z-index: 2;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           å‹•ç•« & éŸ¿æ‡‰å¼
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ç¢ºèªå°è©±æ¡† */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 360px;
            text-align: center;
        }

        .modal-box h3 {
            margin-bottom: 12px;
        }

        .modal-box p {
            color: var(--text-2);
            margin-bottom: 24px;
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
    </style>
</head>

<body>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         CONFIG ERROR (Firebase æœªè¨­å®š)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="screen-error">
        <div style="font-size:48px;margin-bottom:20px;">âš™ï¸</div>
        <h1>Firebase å°šæœªè¨­å®š</h1>
        <p>è«‹é–‹å•Ÿ <strong>index.html</strong> æª”æ¡ˆï¼Œæ‰¾åˆ°æœ€ä¸‹æ–¹ <code>firebaseConfig</code> å€å¡Šï¼Œ<br>å¡«å…¥æ‚¨çš„ Firebase å°ˆæ¡ˆè¨­å®šï¼š</p>
        <code>const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "...",
    databaseURL: "...",
    projectId: "...",
    ...
};</code>
        <p style="margin-top:20px;">ğŸ‘‰ è©³ç´°æ­¥é©Ÿè«‹åƒè€ƒ <strong>SETUP_GUIDE.md</strong></p>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         KIOSK / è»Šä¸»ç«¯
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="view-kiosk" class="view">

        <!-- é ˜è™Ÿ -->
        <div id="kiosk-landing" class="screen active">
            <div class="tesla-wordmark">TESLA</div>
            <div>
                <h1 style="font-size:26px;font-weight:300;margin-bottom:8px;">æ­¡è¿è’è‡¨äº¤ä»˜ä¸­å¿ƒ</h1>
                <p class="landing-subtitle">è«‹é ˜å–æ‚¨çš„å ±åˆ°è™Ÿç¢¼ç‰Œ</p>
            </div>
            <button class="btn-take" id="btnTakeTicket" onclick="takeTicket()">
                <span class="icon">ğŸ«</span>
                <span>é ˜å–è™Ÿç¢¼ç‰Œ</span>
            </button>
            <p style="font-size:13px;color:var(--text-3);">é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä»¥é ˜å–è™Ÿç¢¼</p>
        </div>

        <!-- ç­‰å¾…ä¸­ -->
        <div id="kiosk-waiting" class="screen">
            <div class="tesla-wordmark" style="font-size:20px;letter-spacing:8px;text-indent:8px;">TESLA</div>

            <div class="my-ticket card fade-in">
                <div class="label">æ‚¨çš„è™Ÿç¢¼</div>
                <div class="number" id="myNumber">#â€”</div>
            </div>

            <div class="progress-bar-wrap">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>

            <div class="queue-info fade-in">
                <div class="info-card card">
                    <div class="label">ç›®å‰å«è™Ÿ</div>
                    <div class="value red" id="kioskCurrent">#0</div>
                </div>
                <div class="info-card card">
                    <div class="label">å‰æ–¹ç­‰å¾…</div>
                    <div class="value" id="kioskAhead">â€”</div>
                </div>
                <div class="info-card card">
                    <div class="label">é ä¼°ç­‰å¾…</div>
                    <div class="value green" id="kioskETA">â€”</div>
                </div>
            </div>

            <div class="wake-hint" id="wakeLockHint">
                ğŸ’¡ ç‚ºäº†æ¥æ”¶é€šçŸ¥ï¼Œè«‹ä¿æŒè¢å¹•æ†äº®
            </div>
        </div>

        <!-- è¼ªåˆ°ä½ äº† -->
        <div id="kiosk-called" class="screen">
            <div class="called-icon">ğŸ‰</div>
            <h1>è¼ªåˆ°æ‚¨äº†ï¼</h1>
            <p>è«‹å‰å¾€æ«ƒå°å ±åˆ°</p>
            <div class="called-num" id="calledMyNumber">#â€”</div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ADMIN / ç®¡ç†ç«¯
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="view-admin" class="view">

        <!-- å¯†ç¢¼ -->
        <div id="admin-lock" class="screen active">
            <div class="tesla-wordmark">TESLA</div>
            <h2>ç®¡ç†å¾Œå°ç™»å…¥</h2>
            <div class="input-group">
                <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                    onkeydown="if(event.key==='Enter')adminLogin()">
                <button class="btn btn-primary" onclick="adminLogin()">é€²å…¥</button>
            </div>
            <p class="pwd-error" id="pwdError">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</p>
        </div>

        <!-- å¾Œå°é¢æ¿ -->
        <div id="admin-panel" class="screen">
            <div class="admin-header">
                <h1>ğŸ“‹ å«è™Ÿç®¡ç†</h1>
                <span class="badge badge-green" id="adminSession">å ´æ¬¡é€²è¡Œä¸­</span>
            </div>

            <div class="admin-body">
                <!-- çµ±è¨ˆ -->
                <div class="stats-grid">
                    <div class="stat-card card">
                        <div class="label">å·²é ˜è™Ÿ</div>
                        <div class="value" id="statTotal">0</div>
                    </div>
                    <div class="stat-card card">
                        <div class="label">å·²å«è™Ÿ</div>
                        <div class="value" id="statCalled" style="color:var(--red);">0</div>
                    </div>
                    <div class="stat-card card">
                        <div class="label">ç­‰å¾…ä¸­</div>
                        <div class="value" id="statWaiting" style="color:var(--amber);">0</div>
                    </div>
                </div>

                <!-- å«è™Ÿæ“ä½œ -->
                <div class="section">
                    <h3>å«è™Ÿæ“ä½œ</h3>
                    <div class="action-row">
                        <button class="btn btn-primary btn-call-next" onclick="callNext(1)">
                            ğŸ“¢ å«ä¸‹ä¸€è™Ÿ
                        </button>
                    </div>
                    <div class="action-row" style="margin-top:12px;">
                        <div class="batch-controls">
                            <span style="color:var(--text-2);font-size:14px;">æ‰¹æ¬¡å«è™Ÿï¼š</span>
                            <button class="btn btn-secondary" onclick="callNext(3)">+3</button>
                            <button class="btn btn-secondary" onclick="callNext(5)">+5</button>
                            <button class="btn btn-secondary" onclick="callNext(10)">+10</button>
                            <span style="color:var(--text-3);font-size:13px;margin:0 4px;">æˆ–</span>
                            <input type="number" id="batchSize" value="1" min="1" max="60">
                            <button class="btn btn-secondary" onclick="callNextCustom()">å«è™Ÿ</button>
                        </div>
                    </div>
                </div>

                <!-- QR Code -->
                <div class="section">
                    <h3>è»Šä¸»ç«¯ QR Code</h3>
                    <div class="qr-section">
                        <div class="qr-box" id="adminQR"></div>
                        <p class="qr-url" id="adminQRUrl">â€”</p>
                        <p style="font-size:12px;color:var(--text-3);">åˆ—å°æ­¤ QR Code æ”¾åœ¨å…¥å£è™•ï¼Œè»Šä¸»æƒæå¾Œå³å¯é ˜è™Ÿ</p>
                    </div>
                </div>

                <!-- é‡è¨­ -->
                <div class="section">
                    <h3>å ´æ¬¡ç®¡ç†</h3>
                    <div class="action-row">
                        <button class="btn btn-danger" onclick="showResetModal()">ğŸ”„ é‡è¨­å ´æ¬¡ï¼ˆæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼‰</button>
                    </div>
                </div>
            </div>

            <div class="admin-footer">
                <span><span class="status-dot" id="fbStatusDot"></span><span id="fbStatusText">é€£ç·šä¸­â€¦</span></span>
                <span>Tesla Queue System v1.0</span>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TV DISPLAY / é›»è¦–çœ‹æ¿
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="view-tv" class="view">
        <div class="tv-bg-glow"></div>
        <div class="tv-scanline"></div>

        <div class="tv-header">
            <div class="tesla-wordmark large">TESLA</div>
            <div class="divider"></div>
            <div class="sub">äº¤ ä»˜ ä¸­ å¿ƒ</div>
        </div>

        <div class="tv-main">
            <div class="tv-label">ç›® å‰ å« è™Ÿ</div>
            <div class="tv-number" id="tvNumber">0</div>
            <div class="tv-next" id="tvNext"></div>
        </div>

        <div class="tv-footer">
            <span>å·²é ˜è™Ÿ <span class="val" id="tvTotal">0</span></span>
            <span>ç­‰å¾…ä¸­ <span class="val" id="tvWaiting">0</span></span>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         é‡è¨­ç¢ºèª Modal
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="modal-overlay" id="resetModal">
        <div class="modal-box">
            <h3>âš ï¸ ç¢ºèªé‡è¨­å ´æ¬¡ï¼Ÿ</h3>
            <p>é€™å°‡æ¸…é™¤æ‰€æœ‰å·²é ˜è™Ÿç¢¼èˆ‡å«è™Ÿé€²åº¦ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideResetModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="resetQueue()">ç¢ºèªé‡è¨­</button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         JavaScript
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”¥ Firebase è¨­å®š â€” è«‹å¡«å…¥æ‚¨çš„ Firebase å°ˆæ¡ˆè¨­å®š
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“Œ æ­¥é©Ÿï¼š
        //   1. å‰å¾€ https://console.firebase.google.com/
        //   2. å»ºç«‹æ–°å°ˆæ¡ˆ â†’ å»ºç«‹ Realtime Database
        //   3. åœ¨ã€Œå°ˆæ¡ˆè¨­å®šã€ä¸­è¤‡è£½ä»¥ä¸‹è¨­å®šå€¼
        //   4. å°‡ä¸‹æ–¹ "YOUR_..." æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›å€¼
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const firebaseConfig = {
  apiKey: "AIzaSyCZzriWUnBIPKd9MuiJd5Ym0T7wKit9ul4",
  authDomain: "new-tesla-queue.firebaseapp.com",
  databaseURL: "https://new-tesla-queue-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "new-tesla-queue",
  storageBucket: "new-tesla-queue.firebasestorage.app",
  messagingSenderId: "612392646704",
  appId: "1:612392646704:web:667dd0784c72af409695f5"
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ç®¡ç†å¯†ç¢¼ (å¯è‡ªç”±ä¿®æ”¹)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const ADMIN_PASSWORD = 'tesla';

        // æ¯ä½è»Šä¸»å¹³å‡æœå‹™æ™‚é–“ (åˆ†é˜)ï¼Œç”¨æ–¼é ä¼°ç­‰å¾…æ™‚é–“
        const AVG_SERVICE_MIN = 5;
        // æ«ƒå°æ•¸é‡
        const COUNTER_COUNT = 3;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // å…¨åŸŸè®Šæ•¸
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let db = null;
        let queueRef = null;
        let currentMode = 'kiosk';
        let myTicketNumber = null;
        let prevCalledUpTo = 0;
        let wakeLock = null;
        let audioCtx = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // åˆå§‹åŒ–
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        (function init() {
            // åµæ¸¬æ¨¡å¼
            const params = new URLSearchParams(window.location.search);
            currentMode = params.get('mode') || 'kiosk';

            // é©—è­‰ Firebase è¨­å®š
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === 'YOUR_API_KEY' ||
                !firebaseConfig.databaseURL || firebaseConfig.databaseURL === 'YOUR_DATABASE_URL') {
                document.getElementById('screen-error').classList.add('active');
                return;
            }

            // åˆå§‹åŒ– Firebase
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                queueRef = db.ref('queue');
            } catch (e) {
                console.error('Firebase init error:', e);
                document.getElementById('screen-error').classList.add('active');
                return;
            }

            // é¡¯ç¤ºå°æ‡‰ view
            const viewEl = document.getElementById('view-' + currentMode);
            if (viewEl) {
                viewEl.classList.add('active');
            } else {
                // é è¨­ kiosk
                document.getElementById('view-kiosk').classList.add('active');
                currentMode = 'kiosk';
            }

            // æ ¹æ“šæ¨¡å¼å•Ÿå‹•
            switch (currentMode) {
                case 'kiosk': initKiosk(); break;
                case 'admin': initAdmin(); break;
                case 'tv': initTV(); break;
            }
        })();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ« KIOSK / è»Šä¸»ç«¯
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function initKiosk() {
            // ç›£è½ä½‡åˆ—ç‹€æ…‹ (å³æ™‚æ›´æ–°)
            queueRef.on('value', (snap) => {
                const data = snap.val() || {};
                const calledUpTo = data.calledUpTo || 0;
                const nextTicket = data.nextTicket || 1;
                const sessionId = data.sessionId || '';
                const totalTickets = nextTicket - 1;

                // æ¯æ¬¡éƒ½å¾ localStorage è®€å–ï¼Œé¿å…é–‰åŒ…èˆŠå€¼å•é¡Œ
                const localSession = localStorage.getItem('tq_session');

                // å ´æ¬¡å·²é‡è¨­ â†’ æ¸…é™¤æœ¬åœ°è™Ÿç¢¼
                if (localSession && sessionId !== localSession) {
                    localStorage.removeItem('tq_ticket');
                    localStorage.removeItem('tq_session');
                    myTicketNumber = null;
                    prevCalledUpTo = 0;
                    switchKioskScreen('kiosk-landing');
                    return;
                }

                // è‹¥å·²æœ‰è™Ÿç¢¼ â†’ æ›´æ–°ç­‰å¾…è³‡è¨Š
                if (myTicketNumber !== null) {
                    updateKioskWaiting(calledUpTo, totalTickets);
                }
            });

            // æ¢å¾©å·²é ˜è™Ÿç¢¼ (é é¢è¼‰å…¥æ™‚)
            const saved = localStorage.getItem('tq_ticket');
            const savedSession = localStorage.getItem('tq_session');
            if (saved && savedSession) {
                queueRef.child('sessionId').once('value', (snap) => {
                    if (snap.val() === savedSession) {
                        myTicketNumber = parseInt(saved);
                        document.getElementById('myNumber').textContent = '#' + String(myTicketNumber).padStart(3, '0');
                        document.getElementById('calledMyNumber').textContent = '#' + String(myTicketNumber).padStart(3, '0');
                        switchKioskScreen('kiosk-waiting');
                        requestWakeLock();
                    } else {
                        localStorage.removeItem('tq_ticket');
                        localStorage.removeItem('tq_session');
                    }
                });
            }
        }

        function takeTicket() {
            if (myTicketNumber !== null) return;

            const btn = document.getElementById('btnTakeTicket');
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.6';

            // åŸå­æ€§éå¢ nextTicket
            queueRef.child('nextTicket').transaction((current) => {
                return (current || 1) + 1;
            }, (error, committed, snapshot) => {
                if (error || !committed) {
                    btn.style.pointerEvents = '';
                    btn.style.opacity = '';
                    alert('é ˜è™Ÿå¤±æ•—ï¼Œè«‹é‡è©¦');
                    return;
                }

                myTicketNumber = snapshot.val() - 1;
                const formatted = '#' + String(myTicketNumber).padStart(3, '0');

                // åˆå§‹åŒ– sessionId (å¦‚æœæ˜¯ç¬¬ä¸€ä½)
                queueRef.child('sessionId').once('value', (snap) => {
                    let sid = snap.val();
                    if (!sid) {
                        sid = Date.now().toString(36);
                        queueRef.child('sessionId').set(sid);
                    }
                    localStorage.setItem('tq_ticket', myTicketNumber);
                    localStorage.setItem('tq_session', sid);
                });

                // é¡¯ç¤ºè™Ÿç¢¼
                document.getElementById('myNumber').textContent = formatted;
                document.getElementById('calledMyNumber').textContent = formatted;
                switchKioskScreen('kiosk-waiting');
                requestWakeLock();

                // è§¸è¦ºå›é¥‹
                if (navigator.vibrate) navigator.vibrate(100);
            });
        }

        function updateKioskWaiting(calledUpTo, totalTickets) {
            if (myTicketNumber === null) return;

            const ahead = Math.max(0, myTicketNumber - calledUpTo - 1);
            const isCalled = myTicketNumber <= calledUpTo;

            document.getElementById('kioskCurrent').textContent = '#' + String(calledUpTo).padStart(3, '0');
            document.getElementById('kioskAhead').textContent = isCalled ? 'â€”' : ahead + ' äºº';

            // é ä¼°ç­‰å¾…æ™‚é–“: (å‰æ–¹äººæ•¸ / æ«ƒå°æ•¸) * å¹³å‡æœå‹™æ™‚é–“
            const etaMin = Math.ceil((ahead / COUNTER_COUNT) * AVG_SERVICE_MIN);
            document.getElementById('kioskETA').textContent = isCalled ? 'â€”' : ('~' + etaMin + ' åˆ†');

            // é€²åº¦æ¢
            const progress = totalTickets > 0 ? (calledUpTo / totalTickets) * 100 : 0;
            document.getElementById('progressBar').style.width = Math.min(100, progress) + '%';

            // è¼ªåˆ°äº†ï¼
            if (isCalled && calledUpTo > prevCalledUpTo) {
                switchKioskScreen('kiosk-called');
                playNotificationSound();
                if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);
            }

            prevCalledUpTo = calledUpTo;
        }

        function switchKioskScreen(id) {
            document.querySelectorAll('#view-kiosk .screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Wake Lock (é˜²æ­¢é–å±)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function requestWakeLock() {
            const hint = document.getElementById('wakeLockHint');
            if (!('wakeLock' in navigator)) {
                hint.textContent = 'âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è¢å¹•æ†äº®ï¼Œè«‹æ‰‹å‹•ä¿æŒè¢å¹•é–‹å•Ÿ';
                return;
            }
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                hint.textContent = 'âœ… è¢å¹•æ†äº®å·²å•Ÿç”¨ï¼Œè«‹å‹¿é—œé–‰æ­¤é é¢';
                wakeLock.addEventListener('release', () => {
                    hint.textContent = 'âš ï¸ è¢å¹•æ†äº®å·²ä¸­æ–·ï¼Œè«‹å‹¿é–å®šæ‰‹æ©Ÿ';
                });
            } catch (e) {
                hint.textContent = 'âš ï¸ ç„¡æ³•å•Ÿç”¨è¢å¹•æ†äº®ï¼Œè«‹æ‰‹å‹•ä¿æŒè¢å¹•é–‹å•Ÿ';
            }
        }

        // é é¢é‡æ–°å¯è¦‹æ™‚é‡æ–°è«‹æ±‚ wake lock
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && currentMode === 'kiosk' && myTicketNumber !== null) {
                requestWakeLock();
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”Š éŸ³æ•ˆ (Web Audio API)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function playNotificationSound() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                // ä¸‰è²å—¶å—¶
                [0, 0.3, 0.6].forEach(delay => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = 880;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.3, audioCtx.currentTime + delay);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + delay + 0.2);
                    osc.start(audioCtx.currentTime + delay);
                    osc.stop(audioCtx.currentTime + delay + 0.2);
                });
            } catch (e) {
                console.warn('Audio play failed:', e);
            }
        }

        // TV å«è™ŸéŸ³æ•ˆ (è¼ƒä½æ²‰çš„å®å’š)
        function playTVChime() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    const t = audioCtx.currentTime + i * 0.2;
                    gain.gain.setValueAtTime(0.2, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.4);
                    osc.start(t);
                    osc.stop(t + 0.4);
                });
            } catch (e) {
                console.warn('Audio play failed:', e);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ–¥ï¸ ADMIN / ç®¡ç†ç«¯
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function initAdmin() {
            // ç›£è½é€£ç·šç‹€æ…‹
            db.ref('.info/connected').on('value', (snap) => {
                const dot = document.getElementById('fbStatusDot');
                const txt = document.getElementById('fbStatusText');
                if (snap.val() === true) {
                    dot.className = 'status-dot online';
                    txt.textContent = 'Firebase å·²é€£ç·š';
                } else {
                    dot.className = 'status-dot offline';
                    txt.textContent = 'é€£ç·šä¸­æ–·';
                }
            });

            // ç›£è½ä½‡åˆ—
            queueRef.on('value', (snap) => {
                const data = snap.val() || {};
                const calledUpTo = data.calledUpTo || 0;
                const nextTicket = data.nextTicket || 1;
                const total = nextTicket - 1;
                const waiting = Math.max(0, total - calledUpTo);

                document.getElementById('statTotal').textContent = total;
                document.getElementById('statCalled').textContent = calledUpTo;
                document.getElementById('statWaiting').textContent = waiting;
            });
        }

        function adminLogin() {
            const pwd = document.getElementById('adminPwd').value;
            if (pwd === ADMIN_PASSWORD) {
                switchAdminScreen('admin-panel');
                generateQR();
            } else {
                document.getElementById('pwdError').style.display = 'block';
                document.getElementById('adminPwd').value = '';
                if (navigator.vibrate) navigator.vibrate(200);
            }
        }

        function switchAdminScreen(id) {
            document.querySelectorAll('#view-admin .screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function callNext(count) {
            if (!queueRef) return;
            queueRef.child('calledUpTo').transaction((current) => {
                const newVal = (current || 0) + count;
                // ä¸è¶…éå·²é ˜è™Ÿçš„æ•¸é‡
                return newVal;
            });
        }

        function callNextCustom() {
            const n = parseInt(document.getElementById('batchSize').value) || 1;
            callNext(n);
        }

        function generateQR() {
            const container = document.getElementById('adminQR');
            const urlDisplay = document.getElementById('adminQRUrl');
            const baseUrl = window.location.origin + window.location.pathname;
            // è»Šä¸»ç«¯ URL (ä¸å¸¶ mode åƒæ•¸ = é è¨­ kiosk)
            const kioskUrl = baseUrl.replace(/\?.*$/, '');

            container.innerHTML = '';
            try {
                new QRCode(container, {
                    text: kioskUrl,
                    width: 220,
                    height: 220,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (e) {
                container.innerHTML = '<p style="color:var(--text-3)">QR Code ç”¢ç”Ÿå¤±æ•—</p>';
            }
            urlDisplay.textContent = kioskUrl;
        }

        // é‡è¨­
        function showResetModal() {
            document.getElementById('resetModal').classList.add('active');
        }
        function hideResetModal() {
            document.getElementById('resetModal').classList.remove('active');
        }
        function resetQueue() {
            hideResetModal();
            queueRef.set({
                calledUpTo: 0,
                nextTicket: 1,
                sessionId: Date.now().toString(36) + Math.random().toString(36).substr(2, 5)
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“º TV DISPLAY / é›»è¦–çœ‹æ¿
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function initTV() {
            let prevNumber = 0;

            queueRef.on('value', (snap) => {
                const data = snap.val() || {};
                const calledUpTo = data.calledUpTo || 0;
                const nextTicket = data.nextTicket || 1;
                const total = nextTicket - 1;
                const waiting = Math.max(0, total - calledUpTo);

                // æ›´æ–°è™Ÿç¢¼ (æœ‰è®ŠåŒ–æ™‚åŠ å‹•ç•«)
                const numEl = document.getElementById('tvNumber');
                if (calledUpTo !== prevNumber) {
                    numEl.classList.remove('flip');
                    // è§¸ç™¼ reflow é‡æ–°æ’­æ”¾å‹•ç•«
                    void numEl.offsetWidth;
                    numEl.textContent = calledUpTo;
                    numEl.classList.add('flip');

                    // æ’­æ”¾å®å’šéŸ³æ•ˆ (åªåœ¨è™Ÿç¢¼å¢åŠ æ™‚)
                    if (calledUpTo > prevNumber && prevNumber > 0) {
                        playTVChime();
                    }
                    prevNumber = calledUpTo;
                }

                // ä¸‹ä¸€ä½æç¤º
                const nextEl = document.getElementById('tvNext');
                if (calledUpTo < total) {
                    const nextNums = [];
                    for (let i = calledUpTo + 1; i <= Math.min(calledUpTo + 3, total); i++) {
                        nextNums.push('#' + String(i).padStart(3, '0'));
                    }
                    nextEl.innerHTML = 'ä¸‹ä¸€ä½ï¼š<span>' + nextNums.join('ã€') + '</span>';
                } else {
                    nextEl.innerHTML = '';
                }

                document.getElementById('tvTotal').textContent = total;
                document.getElementById('tvWaiting').textContent = waiting;
            });

            // TV é é¢éœ€è¦ä½¿ç”¨è€…äº’å‹•æ‰èƒ½æ’­æ”¾éŸ³æ•ˆ
            // åŠ ä¸€å€‹ä¸€æ¬¡æ€§çš„é»æ“Šäº‹ä»¶ä¾†åˆå§‹åŒ– AudioContext
            document.addEventListener('click', function initAudio() {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                document.removeEventListener('click', initAudio);
            }, { once: true });
        }
    </script>

</body>

</html>